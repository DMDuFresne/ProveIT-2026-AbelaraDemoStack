# =============================================================================
# ProveIT 2026 Demo Stack - Analytics - Docker Compose Configuration
# =============================================================================
# Description: This file contains the configuration for the analytics services of
# the ProveIT 2026 Demo Stack.
#
# It is used to deploy the analytics services using Docker Compose.
#
# =============================================================================

# =============================================================================
# MINIMAL SHARED CONFIGURATIONS
# =============================================================================
x-defaults: &defaults
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: 100m
      max-file: "5"
  security_opt:
    - no-new-privileges:true

x-common-environment: &common-environment
  TZ: ${ANALYTICS_TZ:-America/Chicago}

# =============================================================================
# NETWORKS - External Network
# =============================================================================

networks:
  operations-network:
    external: true

# =============================================================================
# SERVICES
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # MSSQL - Flow Software Backend Database
  # ---------------------------------------------------------------------------

  analytics-mssql:
    <<: *defaults
    user: "0:0"  # Run as root to avoid volume permission issues on Windows
    image: mcr.microsoft.com/mssql/server:${ANALYTICS_MSSQL_VERSION:-2022-latest}
    container_name: proveit-analytics-mssql
    hostname: analytics-mssql
    environment:
      <<: *common-environment
      ACCEPT_EULA: Y
      MSSQL_PID: ${ANALYTICS_MSSQL_PID:-Express}
      MSSQL_SA_PASSWORD: ${ANALYTICS_MSSQL_SA_PASSWORD:-Password1@}
    volumes:
      - proveit-analytics-mssql-data:/var/opt/mssql/data
      - proveit-analytics-mssql-log:/var/opt/mssql/log
      - proveit-analytics-mssql-secrets:/var/opt/mssql/secrets
    ports:
      - "${ANALYTICS_MSSQL_PORT:-1433}:1433"
    networks:
      - operations-network
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"$ANALYTICS_MSSQL_SA_PASSWORD\" -C -Q 'SELECT 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ---------------------------------------------------------------------------
  # Flow Bootstrap - Analytics Platform
  # ---------------------------------------------------------------------------

  analytics-flow-bootstrap:
    <<: *defaults
    image: flowsoftwareinc/flowbootstrap:${ANALYTICS_FLOW_VERSION:-latest}
    container_name: proveit-analytics-flow-bootstrap
    hostname: analytics-flow-bootstrap
    environment:
      <<: *common-environment
      FLOW_PLATFORM_NAME: ${ANALYTICS_FLOW_PLATFORM_NAME}
      FLOW_ADMIN_PASSWORD: ${ANALYTICS_FLOW_ADMIN_PASSWORD}
      FLOW_DB_SERVER: analytics-mssql
      FLOW_DB_PORT: 1433
      FLOW_DB_NAME: ${ANALYTICS_FLOW_DB_NAME:-FlowSoftware}
      FLOW_DB_USERNAME: sa
      FLOW_DB_PASSWORD: ${ANALYTICS_MSSQL_SA_PASSWORD}
      TIMESCALE_HOST: timescaledb
      TIMESCALE_PORT: 5432
      TIMESCALE_DB: proveit_ops
      TIMESCALE_USER: postgres
      TIMESCALE_PASSWORD: ${ANALYTICS_POSTGRES_PASSWORD}
    volumes:
      - proveit-analytics-flow-data:/usr/local/flowbootstrap/appData
      - proveit-analytics-flow-config:/usr/local/flowbootstrap/config
    ports:
      - "${ANALYTICS_FLOW_BOOTSTRAP_PORT:-4501}:4501"
      - "${ANALYTICS_FLOW_HTTP_PORT:-80}:80"
      - "${ANALYTICS_FLOW_HTTPS_PORT:-443}:443"
    networks:
      - operations-network
    depends_on:
      analytics-mssql:
        condition: service_healthy

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  proveit-analytics-mssql-data:
  proveit-analytics-mssql-log:
  proveit-analytics-mssql-secrets:
  proveit-analytics-flow-data:
  proveit-analytics-flow-config:
