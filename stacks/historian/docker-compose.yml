# =============================================================================
# ProveIT 2026 Demo Stack - Historian - Docker Compose Configuration
# =============================================================================
# Description: This file contains the configuration for the historian services of
# the ProveIT 2026 Demo Stack.
#
# It is used to deploy the historian services using Docker Compose.
#
# =============================================================================

# =============================================================================
# MINIMAL SHARED CONFIGURATIONS
# =============================================================================
x-defaults: &defaults
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: 100m
      max-file: "5"
  security_opt:
    - no-new-privileges:true

x-common-environment: &common-environment
  TZ: ${HISTORIAN_TZ:-America/Chicago}

x-collector-common: &collector-common
  image: timebase/collector:${HISTORIAN_COLLECTOR_TAG:-latest}
  networks:
    - timebase-network
  depends_on:
    - timebase-historian

# =============================================================================
# NETWORKS
# =============================================================================
# Note: This stack creates its own network for Timebase services

networks:
  timebase-network:
    name: ${HISTORIAN_NETWORK_NAME:-timebase-network}
    driver: bridge

# =============================================================================
# SERVICES
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # Timebase Historian - Time Series Database
  # ---------------------------------------------------------------------------

  timebase-historian:
    <<: *defaults
    image: timebase/historian:${HISTORIAN_HISTORIAN_TAG:-latest}
    container_name: proveit-historian
    hostname: ${HISTORIAN_HISTORIAN_HOSTNAME:-historian}
    environment:
      <<: *common-environment
      Settings: /historian/settings
      Data: /historian/data
      Logs: /historian/logs
    volumes:
      - proveit-historian-data:/historian
    ports:
      - "${HISTORIAN_HISTORIAN_PORT:-4511}:4511"
    networks:
      - timebase-network

  # ---------------------------------------------------------------------------
  # Timebase Explorer - Historian Web Interface
  # ---------------------------------------------------------------------------

  timebase-explorer:
    <<: *defaults
    image: timebase/explorer:${HISTORIAN_EXPLORER_TAG:-latest}
    container_name: proveit-explorer
    hostname: ${HISTORIAN_EXPLORER_HOSTNAME:-explorer}
    environment:
      <<: *common-environment
      Settings: /explorer/settings
      Config: /explorer/config
      Data: /explorer/data
      Logs: /explorer/logs
      HISTORIAN_HOST: ${HISTORIAN_HISTORIAN_HOSTNAME:-historian}
    volumes:
      - proveit-explorer-data:/explorer
    ports:
      - "${HISTORIAN_EXPLORER_PORT:-4531}:4531"
    networks:
      - timebase-network
    depends_on:
      - timebase-historian
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        mkdir -p /explorer/config
        cat > /explorer/config/sources.config <<EOF
        {
          "Historians": {
            "Local": {
              "Name": "Local",
              "Host": "${HISTORIAN_HISTORIAN_HOSTNAME:-historian}",
              "Port": 4511,
              "UseTls": false,
              "Auth": {
                "Enabled": false,
                "IdP": {
                  "Host": "localhost",
                  "Port": 4542,
                  "UseTls": true
                },
                "ClientId": "",
                "ClientSecret": ""
              }
            }
          }
        }
        EOF
        exec dotnet Timebase.Explorer.UI.dll

  # ---------------------------------------------------------------------------
  # Timebase Collector 01 - Data Collection Service
  # ---------------------------------------------------------------------------

  timebase-collector-01:
    <<: [*defaults, *collector-common]
    container_name: proveit-collector-01
    hostname: ${HISTORIAN_COLLECTOR_01_HOSTNAME:-collector-01}
    environment:
      <<: *common-environment
      Active: ${HISTORIAN_COLLECTOR_01_ACTIVE:-false}
      Settings: /collector/settings
      Config: /collector/config
      Data: /collector/data
      Logs: /collector/logs
    ports:
      - "${HISTORIAN_COLLECTOR_01_PORT:-4521}:4521"
    volumes:
      - proveit-collector-01-data:/collector

  # ---------------------------------------------------------------------------
  # Timebase Collector 02 - Data Collection Service
  # ---------------------------------------------------------------------------

  timebase-collector-02:
    <<: [*defaults, *collector-common]
    container_name: proveit-collector-02
    hostname: ${HISTORIAN_COLLECTOR_02_HOSTNAME:-collector-02}
    environment:
      <<: *common-environment
      Active: ${HISTORIAN_COLLECTOR_02_ACTIVE:-false}
      Settings: /collector/settings
      Config: /collector/config
      Data: /collector/data
      Logs: /collector/logs
    ports:
      - "${HISTORIAN_COLLECTOR_02_PORT:-4522}:4521"
    volumes:
      - proveit-collector-02-data:/collector

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  proveit-historian-data:
  proveit-collector-01-data:
  proveit-collector-02-data:
  proveit-explorer-data:
