# =============================================================================
# ProveIT 2026 Demo Stack - PostgreSQL Configuration
# =============================================================================
# Description: Optimized PostgreSQL configuration for Ignition gateways
# This configuration is tuned for industrial SCADA/MES workloads
# Fixed for PostgreSQL 16 compatibility
# =============================================================================

# -----------------------------------------------------------------------------
# CONNECTION AND AUTHENTICATION
# -----------------------------------------------------------------------------

# Listen on all network interfaces (required for Docker networking)
listen_addresses = '*'

# Maximum number of concurrent connections
# Calculated as: (4 gateways * 40 connections) + monitoring + buffer
max_connections = 200

# Reserved connections for superuser
superuser_reserved_connections = 3

# Authentication timeout
authentication_timeout = 60s

# -----------------------------------------------------------------------------
# MEMORY CONFIGURATION
# -----------------------------------------------------------------------------

# Shared memory for caching (25% of system RAM recommended)
# This value should be overridden by environment variable
shared_buffers = 512MB

# Memory for each query operation
# Ignition typically runs many small queries
work_mem = 8MB

# Memory for maintenance operations (VACUUM, CREATE INDEX, etc.)
maintenance_work_mem = 128MB

# Stack depth (standard for most systems)
max_stack_depth = 2MB

# Dynamic shared memory
dynamic_shared_memory_type = posix

# Cache size hint for query planner (50-75% of total RAM)
effective_cache_size = 2GB

# -----------------------------------------------------------------------------
# WRITE AHEAD LOG (WAL) CONFIGURATION
# -----------------------------------------------------------------------------

# WAL level for replication and point-in-time recovery
wal_level = replica

# Minimum WAL size
min_wal_size = 80MB

# Maximum WAL size before checkpoint
max_wal_size = 1GB

# WAL buffer size
wal_buffers = 16MB

# Force data to disk to ensure durability
fsync = on
synchronous_commit = on

# Checkpoint settings for write performance
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
checkpoint_warning = 30s

# Archive mode (disabled by default, enable for backup strategies)
archive_mode = off
# archive_command = 'cp %p /backups/wal_archive/%f'

# -----------------------------------------------------------------------------
# QUERY TUNING
# -----------------------------------------------------------------------------

# Planner cost constants (tuned for SSD storage)
random_page_cost = 1.1
seq_page_cost = 1.0
cpu_tuple_cost = 0.01
cpu_index_tuple_cost = 0.005
cpu_operator_cost = 0.0025

# Enable query planning optimizations
enable_partitionwise_join = on
enable_partitionwise_aggregate = on

# Genetic query optimizer
geqo = on
geqo_threshold = 12

# Statistics target for better query plans
default_statistics_target = 100

# Statement timeout (prevent runaway queries)
statement_timeout = 300000  # 5 minutes

# Lock timeout
lock_timeout = 60000  # 1 minute

# Idle in transaction timeout
idle_in_transaction_session_timeout = 600000  # 10 minutes

# -----------------------------------------------------------------------------
# PARALLEL QUERY EXECUTION
# -----------------------------------------------------------------------------

# Maximum parallel workers
max_parallel_workers = 4
max_parallel_workers_per_gather = 2
max_parallel_maintenance_workers = 2

# Minimum table size for parallel scan
min_parallel_table_scan_size = 8MB
min_parallel_index_scan_size = 512kB

# -----------------------------------------------------------------------------
# BACKGROUND WRITER AND AUTOVACUUM
# -----------------------------------------------------------------------------

# Background writer settings
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# Autovacuum settings (critical for SCADA systems)
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 60s

# Vacuum thresholds
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

# Prevent autovacuum from being too aggressive
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 1000

# -----------------------------------------------------------------------------
# LOGGING
# -----------------------------------------------------------------------------

# Where to log
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# What to log
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_lock_waits = on
log_statement = 'ddl'  # Log DDL statements only
log_temp_files = 256kB

# Error reporting
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = 1000  # Log slow queries (>1 second)

# Performance insights
log_autovacuum_min_duration = 1000
track_activities = on
track_counts = on
track_io_timing = on
track_functions = pl

# -----------------------------------------------------------------------------
# STATISTICS
# -----------------------------------------------------------------------------

# Statistics collection
# NOTE: stats_temp_directory was removed in PostgreSQL 15
# Statistics are now automatically managed by the system

# Query and index usage statistics
track_activity_query_size = 2048
compute_query_id = on

# -----------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
# -----------------------------------------------------------------------------

# Timezone
timezone = 'America/Chicago'

# Locale settings
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Default text search configuration
default_text_search_config = 'pg_catalog.english'

# Statement behavior
default_transaction_isolation = 'read committed'
default_transaction_read_only = off
default_transaction_deferrable = off

# -----------------------------------------------------------------------------
# RESOURCE LIMITS
# -----------------------------------------------------------------------------

# Temporary file limit per session
temp_file_limit = 2GB

# -----------------------------------------------------------------------------
# EXTENSIONS
# -----------------------------------------------------------------------------

# Preload shared libraries for better performance
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements configuration
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = off
pg_stat_statements.save = on

# -----------------------------------------------------------------------------
# REPLICATION (prepared for future high availability)
# -----------------------------------------------------------------------------

# Maximum replication slots
max_replication_slots = 4

# Maximum WAL senders
max_wal_senders = 4

# WAL receiver timeout
wal_receiver_timeout = 60s

# -----------------------------------------------------------------------------
# IGNITION-SPECIFIC OPTIMIZATIONS
# -----------------------------------------------------------------------------

# Ignition often uses prepared statements
max_prepared_transactions = 100

# Longer TCP keepalive for stable industrial networks
tcp_keepalives_idle = 600
tcp_keepalives_interval = 60
tcp_keepalives_count = 10

# NOTE: max_identifier_length is a compile-time parameter and cannot be changed
# PostgreSQL 16 has a default identifier length of 63 characters
# If longer identifiers are needed, PostgreSQL must be compiled with a different value

# -----------------------------------------------------------------------------
# SECURITY
# -----------------------------------------------------------------------------

# Row-level security
row_security = on

# SSL (configure based on deployment requirements)
# ssl = on
# ssl_cert_file = 'server.crt'
# ssl_key_file = 'server.key'
# ssl_ca_file = 'root.crt'

# Password encryption
password_encryption = scram-sha-256