# =============================================================================
# ProveIT 2026 Demo Stack - Utility - Docker Compose Configuration
# =============================================================================
# Description: This file contains the configuration for the utility services of
# the ProveIT 2026 Demo Stack.
#
# It is used to deploy the utility services using Docker Compose.
#
# =============================================================================

# =============================================================================
# MINIMAL SHARED CONFIGURATIONS
# =============================================================================
x-defaults: &defaults
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: 100m
      max-file: "5"
  security_opt:
    - no-new-privileges:true

x-common-environment: &common-environment
  TZ: ${UTILITY_TZ:-America/Chicago}

# =============================================================================
# NETWORKS - External Network
# =============================================================================

networks:
  operations-network:
    external: true

# =============================================================================
# SERVICES
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # Homepage - Web Dashboard
  # ---------------------------------------------------------------------------
  homepage:
    <<: *defaults
    image: ghcr.io/gethomepage/homepage:${UTILITY_HOMEPAGE_VERSION:-latest}
    container_name: proveit-homepage
    hostname: proveit-homepage
    environment:
      <<: *common-environment
      LOG_LEVEL: info
    volumes:
      - ./config/homepage/config:/app/config
      - ./config/homepage/icons:/app/public/icons
      - ./config/homepage/images:/app/public/images
      - /var/run/docker.sock:/var/run/docker.sock:ro
    ports:
      - "${UTILITY_HOMEPAGE_PORT:-3000}:3000"
    networks:
      - operations-network

  # ---------------------------------------------------------------------------
  # DBeaver - Database Management Tool
  # ---------------------------------------------------------------------------

  dbeaver:
    <<: *defaults
    image: dbeaver/cloudbeaver:${UTILITY_DBEAVER_VERSION:-latest}
    container_name: proveit-dbeaver
    hostname: dbeaver
    environment:
      <<: *common-environment
    volumes:
      - proveit-utility-dbeaver-workspace:/opt/cloudbeaver/workspace
      - proveit-utility-dbeaver-data:/opt/cloudbeaver/data
    ports:
      - "${UTILITY_DBEAVER_PORT:-8978}:8978"
    networks:
      - operations-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:8978 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ---------------------------------------------------------------------------
  # MQTT Explorer - MQTT Broker Explorer
  # ---------------------------------------------------------------------------

  mqtt-explorer:
    <<: *defaults
    image: smeagolworms4/mqtt-explorer:${UTILITY_MQTT_EXPLORER_VERSION:-latest}
    container_name: proveit-mqtt-explorer
    hostname: mqtt-explorer
    environment:
      <<: *common-environment
      HTTP_PORT: ${UTILITY_MQTT_EXPLORER_PORT:-4000}
      MQTT_HOST: ${UTILITY_MQTT_EXPLORER_DEFAULT_HOST:-hivemq}
      MQTT_PORT: ${UTILITY_MQTT_EXPLORER_DEFAULT_PORT:-1883}
      MQTT_CLIENT_ID: ${UTILITY_MQTT_EXPLORER_CLIENT_ID:-mqtt-explorer}
    volumes:
      - proveit-utility-mqtt-explorer-config:/mqtt-explorer/config
      - proveit-utility-mqtt-explorer-db:/mqtt-explorer/db
    ports:
      - "${UTILITY_MQTT_EXPLORER_PORT:-4000}:4000"
    networks:
      - operations-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:4000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  proveit-utility-mqtt-explorer-config:
  proveit-utility-mqtt-explorer-db:
  proveit-utility-dbeaver-workspace:
  proveit-utility-dbeaver-data:
