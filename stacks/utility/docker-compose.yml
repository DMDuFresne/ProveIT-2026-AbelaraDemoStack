# =============================================================================
# ProveIT 2026 Demo Stack - Utility - Docker Compose Configuration
# =============================================================================
# Description: This file contains the configuration for the utility services of
# the ProveIT 2026 Demo Stack.
#
# It is used to deploy the utility services using Docker Compose.
#
# =============================================================================

# =============================================================================
# MINIMAL SHARED CONFIGURATIONS
# =============================================================================
x-defaults: &defaults
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: 100m
      max-file: "5"
  security_opt:
    - no-new-privileges:true

x-common-environment: &common-environment
  TZ: ${UTILITY_TZ:-America/Chicago}

# =============================================================================
# NETWORKS - External Networks
# =============================================================================

networks:
  operations-network:
    external: true
  routing-network:
    external: true

# =============================================================================
# SERVICES
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # Docker Socket Proxy - Secure Docker API Access
  # ---------------------------------------------------------------------------
  utility-docker-socket-proxy:
    <<: *defaults
    image: tecnativa/docker-socket-proxy:latest
    container_name: proveit-utility-docker-socket-proxy
    hostname: utility-docker-socket-proxy
    environment:
      <<: *common-environment
      # Read-only access to containers and basic info
      CONTAINERS: 1
      INFO: 1
      IMAGES: 1
      NETWORKS: 1
      SERVICES: 1
      TASKS: 1
      # Deny all write/dangerous operations
      POST: 0
      BUILD: 0
      COMMIT: 0
      CONFIGS: 0
      DISTRIBUTION: 0
      EXEC: 0
      GRPC: 0
      NODES: 0
      PLUGINS: 0
      SECRETS: 0
      SESSION: 0
      SWARM: 0
      SYSTEM: 0
      VOLUMES: 0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - operations-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:2375/version || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # Homepage - Web Dashboard
  # ---------------------------------------------------------------------------
  utility-homepage:
    <<: *defaults
    image: ghcr.io/gethomepage/homepage:${UTILITY_HOMEPAGE_VERSION:-latest}
    container_name: proveit-utility-homepage
    hostname: utility-homepage
    environment:
      <<: *common-environment
      LOG_LEVEL: info
      DOCKER_HOST: tcp://utility-docker-socket-proxy:2375
      HOMEPAGE_ALLOWED_HOSTS: localhost,utility-homepage,homepage.utility.abelara.cloud
    volumes:
      - ./config/homepage/config:/app/config
      - ./config/homepage/icons:/app/public/icons
      - ./config/homepage/images:/app/public/images
    ports:
      - "${UTILITY_HOMEPAGE_PORT:-3000}:3000"
    networks:
      - operations-network
    depends_on:
      utility-docker-socket-proxy:
        condition: service_healthy

  # ---------------------------------------------------------------------------
  # DBeaver - Database Management Tool
  # ---------------------------------------------------------------------------

  utility-dbeaver:
    <<: *defaults
    image: dbeaver/cloudbeaver:${UTILITY_DBEAVER_VERSION:-latest}
    container_name: proveit-utility-dbeaver
    hostname: utility-dbeaver
    environment:
      <<: *common-environment
    volumes:
      - proveit-utility-dbeaver-workspace:/opt/cloudbeaver/workspace
      - proveit-utility-dbeaver-data:/opt/cloudbeaver/data
    ports:
      - "${UTILITY_DBEAVER_PORT:-8978}:8978"
    networks:
      - operations-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:8978 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ---------------------------------------------------------------------------
  # MQTT Explorer - MQTT Broker Explorer
  # ---------------------------------------------------------------------------

  utility-mqtt-explorer:
    <<: *defaults
    image: smeagolworms4/mqtt-explorer:${UTILITY_MQTT_EXPLORER_VERSION:-latest}
    container_name: proveit-utility-mqtt-explorer
    hostname: utility-mqtt-explorer
    environment:
      <<: *common-environment
      HTTP_PORT: ${UTILITY_MQTT_EXPLORER_PORT:-4000}
      MQTT_HOST: ${UTILITY_MQTT_EXPLORER_DEFAULT_HOST:-hivemq}
      MQTT_PORT: ${UTILITY_MQTT_EXPLORER_DEFAULT_PORT:-1883}
      MQTT_CLIENT_ID: ${UTILITY_MQTT_EXPLORER_CLIENT_ID:-mqtt-explorer}
    volumes:
      - proveit-utility-mqtt-explorer-config:/mqtt-explorer/config
      - proveit-utility-mqtt-explorer-db:/mqtt-explorer/db
    ports:
      - "${UTILITY_MQTT_EXPLORER_PORT:-4000}:4000"
    networks:
      - operations-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:4000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ---------------------------------------------------------------------------
  # Nginx Reverse Proxy - Path Rewriting for Cloudflare Tunnel
  # ---------------------------------------------------------------------------

  utility-nginx:
    <<: *defaults
    image: nginx:${UTILITY_NGINX_VERSION:-alpine}
    container_name: proveit-utility-nginx
    hostname: utility-nginx
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "${UTILITY_NGINX_PORT:-8081}:80"
    networks:
      - operations-network
      - routing-network
    depends_on:
      utility-homepage:
        condition: service_started
      utility-dbeaver:
        condition: service_healthy
      utility-mqtt-explorer:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1/nginx-health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ---------------------------------------------------------------------------
  # Cloudflare Tunnel - External Access
  # ---------------------------------------------------------------------------

  utility-cloudflared:
    <<: *defaults
    image: cloudflare/cloudflared:latest
    container_name: proveit-utility-cloudflared
    hostname: utility-cloudflared
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${UTILITY_CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - routing-network
    depends_on:
      utility-nginx:
        condition: service_healthy
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  proveit-utility-mqtt-explorer-config:
  proveit-utility-mqtt-explorer-db:
  proveit-utility-dbeaver-workspace:
  proveit-utility-dbeaver-data:
