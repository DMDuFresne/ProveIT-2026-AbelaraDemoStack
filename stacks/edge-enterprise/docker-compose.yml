# =============================================================================
# ProveIT 2026 Demo Stack - Edge Enterprise - Docker Compose Configuration
# =============================================================================
# Description: This file contains the configuration for the Edge Enterprise services of 
# the ProveIT 2026 Demo Stack.
# 
# It is used to deploy the Edge Enterprise services using Docker Compose.
# 
# =============================================================================

# =============================================================================
# MINIMAL SHARED CONFIGURATIONS
# =============================================================================
x-defaults: &defaults
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: 100m
      max-file: "5"
  security_opt:
    - no-new-privileges:true

x-common-environment: &common-environment
  TZ: ${EDGE_ENTERPRISE_TZ:-America/Chicago}

# =============================================================================
# NETWORKS - External Network
# =============================================================================

networks:
  operations-network:
    external: true

# =============================================================================
# SERVICES
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # Fuuz Device Gateway - Edge Enterprise
  # ---------------------------------------------------------------------------

  fuuz-device-gateway:
    <<: *defaults
    image: public.ecr.aws/n9a9v7z5/build/mfgx-native-app-device-gateway-server:${EDGE_ENTERPRISE_FUUZ_VERSION:-latest}
    container_name: edge-enterprise-fuuz-gateway
    hostname: fuuz-device-gateway
    pull_policy: always
    stop_grace_period: 60s
    environment:
      <<: *common-environment
      NODE_ENV: ${EDGE_ENTERPRISE_NODE_ENV:-production}
      FUUZ_GATEWAY_AUTO_UPDATE: ${EDGE_ENTERPRISE_FUUZ_GATEWAY_AUTO_UPDATE:-false}
      FUUZ_GATEWAY_LOG_LEVEL: ${EDGE_ENTERPRISE_FUUZ_GATEWAY_LOG_LEVEL:-verbose}
      FUUZ_GATEWAY_LOG_RETENTION_DAYS: ${EDGE_ENTERPRISE_FUUZ_GATEWAY_LOG_RETENTION_DAYS:-30}
      FUUZ_GATEWAY_PORT: ${EDGE_ENTERPRISE_FUUZ_GATEWAY_PORT:-5500}
      FUUZ_GATEWAY_LISTEN_ADDRESS: ${EDGE_ENTERPRISE_FUUZ_GATEWAY_LISTEN_ADDRESS:-0.0.0.0}
    volumes:
      - proveit-edge-enterprise-fuuz-gateway-app-data:/root/.fuuzdevicegateway
      - proveit-edge-enterprise-fuuz-gateway-drivers:/fuuzdevicegateway/drivers
    ports:
      - "${EDGE_ENTERPRISE_FUUZ_GATEWAY_PORT_RANGE:-5500-5550}:5500-5550"
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - operations-network
    command: /fuuzdevicegateway/fuuzdevicegateway
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost ${EDGE_ENTERPRISE_FUUZ_GATEWAY_PORT:-5500} || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  proveit-edge-enterprise-fuuz-gateway-app-data:
  proveit-edge-enterprise-fuuz-gateway-drivers:
