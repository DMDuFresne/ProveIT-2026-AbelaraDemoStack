# =============================================================================
# ProveIT 2026 Demo Stack - MES - Docker Compose Configuration
# =============================================================================
# Description: This file contains the configuration for the MES services of 
# the ProveIT 2026 Demo Stack.
# 
# It is used to deploy the MES services using Docker Compose.
# 
# =============================================================================

# =============================================================================
# MINIMAL SHARED CONFIGURATIONS
# =============================================================================
x-defaults: &defaults
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: 100m
      max-file: "5"
  security_opt:
    - no-new-privileges:true

x-common-environment: &common-environment
  TZ: ${MES_TZ:-America/Chicago}

x-ignition-common: &ignition-common
  # Common Ignition Gateway Configuration
  # Admin password can be set via GATEWAY_ADMIN_PASSWORD or GATEWAY_ADMIN_PASSWORD_FILE (for secrets)
  GATEWAY_ADMIN_PASSWORD: ${MES_IGNITION_GATEWAY_ADMIN_PASSWORD}
  GATEWAY_ADMIN_PASSWORD_FILE: ${MES_IGNITION_GATEWAY_ADMIN_PASSWORD_FILE:-}
  IGNITION_EDITION: ${MES_IGNITION_EDITION:-standard}
  # Security: Run as non-root user (optional, uncomment and set if needed)
  # IGNITION_UID: ${IGNITION_UID:-}
  # IGNITION_GID: ${IGNITION_GID:-}

# =============================================================================
# NETWORKS - External Networks
# =============================================================================

networks:
  operations-network:
    external: true
  routing-network:
    external: true

# =============================================================================
# SERVICES
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # MES Database - TimescaleDB
  # ---------------------------------------------------------------------------

  mes-timescaledb:
    <<: *defaults
    image: timescale/timescaledb:${MES_TIMESCALEDB_VERSION:-latest-pg17}
    container_name: proveit-mes-timescaledb
    hostname: mes-timescaledb
    environment:
      <<: *common-environment
      POSTGRES_DB: proveit-mes
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${MES_POSTGRES_PASSWORD}
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
      POSTGRES_INITDB_ARGS: --auth-host=scram-sha-256
    volumes:
      - proveit-mes-timescaledb-data:/var/lib/postgresql/data
      - ./config/database/creation:/docker-entrypoint-initdb.d:ro
    ports:
      - "${MES_TIMESCALE_PORT:-5433}:5432"
    networks:
      - operations-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d proveit-mes"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ---------------------------------------------------------------------------
  # MES Connection Pooler - PgBouncer
  # ---------------------------------------------------------------------------

  mes-pgbouncer:
    <<: *defaults
    image: edoburu/pgbouncer:${MES_PGBOUNCER_VERSION:-latest}
    container_name: proveit-mes-pgbouncer
    hostname: mes-pgbouncer
    environment:
      <<: *common-environment
      DATABASE_URL: postgres://postgres:${MES_POSTGRES_PASSWORD}@mes-timescaledb:5432/proveit-mes
      AUTH_TYPE: scram-sha-256
      AUTH_FILE: /etc/pgbouncer/userlist.txt
      AUTH_QUERY: SELECT usename, passwd FROM pg_shadow WHERE usename=$1
      AUTH_USER: postgres
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 200
      DEFAULT_POOL_SIZE: 25
      MIN_POOL_SIZE: 5
      RESERVE_POOL_SIZE: 5
      RESERVE_POOL_TIMEOUT: 3
      SERVER_LIFETIME: 86400
      SERVER_IDLE_TIMEOUT: 600
      LOG_CONNECTIONS: 0
      LOG_DISCONNECTIONS: 0
    ports:
      - "${MES_PGBOUNCER_PORT:-6433}:5432"
    networks:
      - operations-network
    healthcheck:
      test: ["CMD-SHELL", "PGPASSWORD=${MES_POSTGRES_PASSWORD} psql -h localhost -p 5432 -U postgres -d proveit-mes -c 'SELECT 1;' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      mes-timescaledb:
        condition: service_healthy

  # ---------------------------------------------------------------------------
  # MES Backend - Ignition
  # ---------------------------------------------------------------------------

  mes-ignition-backend:
    <<: *defaults
    image: inductiveautomation/ignition:${MES_IGNITION_BACKEND_VERSION:-8.3}
    container_name: proveit-mes-ignition-backend
    hostname: mes-ignition-backend
    environment:
      <<: [*common-environment, *ignition-common]
      # EULA Acceptance
      ACCEPT_IGNITION_EULA: Y
      # Admin Credentials
      GATEWAY_ADMIN_USERNAME: ${MES_GATEWAY_ADMIN_USERNAME:-admin}
      # Gateway Identification
      GATEWAY_SYSTEM_NAME: ${MES_IGNITION_MES_BACKEND_GATEWAY_SYSTEM_NAME:-ProveIT-Backend}
      # Network Configuration
      GATEWAY_NETWORK_UUID: ${MES_IGNITION_MES_BACKEND_NETWORK_UUID}
      GATEWAY_NETWORK_ENABLED: ${MES_IGNITION_GATEWAY_NETWORK_ENABLED:-true}
      GATEWAY_NETWORK_REQUIRESSL: ${MES_IGNITION_GATEWAY_NETWORK_REQUIRESSL:-false}
      GATEWAY_NETWORK_ALLOWINCOMING: ${MES_IGNITION_GATEWAY_NETWORK_ALLOWINCOMING:-true}
      # Module Configuration
      GATEWAY_MODULES_ENABLED: ${MES_GATEWAY_MODULES_ENABLED_BACKEND:-all}
      # Memory Settings
      GATEWAY_INIT_MEMORY: ${MES_GATEWAY_INIT_MEMORY_BACKEND:-1024m}
      GATEWAY_MAX_MEMORY: ${MES_GATEWAY_MAX_MEMORY_BACKEND:-4096m}
      # Activation/Licensing (can use IGNITION_MES_BACKEND_ACTIVATION_TOKEN_FILE for secrets)
      IGNITION_ACTIVATION_TOKEN: ${MES_IGNITION_MES_BACKEND_ACTIVATION_TOKEN}
      IGNITION_ACTIVATION_TOKEN_FILE: ${MES_IGNITION_MES_BACKEND_ACTIVATION_TOKEN_FILE:-}
      # Feature Flags
      DISABLE_QUICKSTART: ${MES_DISABLE_QUICKSTART:-false}
      # Security (optional, uncomment if using non-root user)
      # IGNITION_UID: ${IGNITION_UID:-}
      # IGNITION_GID: ${IGNITION_GID:-}
    volumes:
      - proveit-mes-ignition-backend-data:/usr/local/bin/ignition/data
    ports:
      - "${MES_IGNITION_BACKEND_HTTP_PORT:-8090}:8088"
      - "${MES_IGNITION_BACKEND_HTTPS_PORT:-8047}:8043"
      - "${MES_IGNITION_BACKEND_GATEWAY_PORT:-8062}:8060"
    networks:
      - operations-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8088/StatusPing || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # ---------------------------------------------------------------------------
  # MES Frontend - Ignition
  # ---------------------------------------------------------------------------

  mes-ignition-frontend-01:
    <<: *defaults
    image: inductiveautomation/ignition:${MES_IGNITION_FRONTEND_VERSION:-8.3}
    container_name: proveit-mes-ignition-frontend-01
    hostname: mes-ignition-frontend-01
    environment:
      <<: [*common-environment, *ignition-common]
      # EULA Acceptance
      ACCEPT_IGNITION_EULA: Y
      # Admin Credentials
      GATEWAY_ADMIN_USERNAME: ${MES_GATEWAY_ADMIN_USERNAME:-admin}
      # Gateway Identification
      GATEWAY_SYSTEM_NAME: ${MES_IGNITION_MES_FRONTEND_GATEWAY_SYSTEM_NAME:-ProveIT-Frontend}
      # Network Configuration
      GATEWAY_NETWORK_UUID: ${MES_IGNITION_MES_FRONTEND_NETWORK_UUID}
      GATEWAY_NETWORK_ENABLED: ${MES_IGNITION_GATEWAY_NETWORK_ENABLED:-true}
      GATEWAY_NETWORK_REQUIRESSL: ${MES_IGNITION_GATEWAY_NETWORK_REQUIRESSL:-false}
      GATEWAY_NETWORK_ALLOWINCOMING: ${MES_IGNITION_GATEWAY_NETWORK_ALLOWINCOMING:-true}
      # Module Configuration
      GATEWAY_MODULES_ENABLED: ${MES_GATEWAY_MODULES_ENABLED_FRONTEND:-all}
      # Memory Settings
      GATEWAY_INIT_MEMORY: ${MES_GATEWAY_INIT_MEMORY_FRONTEND:-1024m}
      GATEWAY_MAX_MEMORY: ${MES_GATEWAY_MAX_MEMORY_FRONTEND:-4096m}
      # Activation/Licensing (can use IGNITION_MES_FRONTEND_ACTIVATION_TOKEN_FILE for secrets)
      IGNITION_ACTIVATION_TOKEN: ${MES_IGNITION_MES_FRONTEND_ACTIVATION_TOKEN}
      IGNITION_ACTIVATION_TOKEN_FILE: ${MES_IGNITION_MES_FRONTEND_ACTIVATION_TOKEN_FILE:-}
      # Feature Flags
      DISABLE_QUICKSTART: ${MES_DISABLE_QUICKSTART:-false}
      # Security (optional, uncomment if using non-root user)
      # IGNITION_UID: ${IGNITION_UID:-}
      # IGNITION_GID: ${IGNITION_GID:-}
    volumes:
      - proveit-mes-ignition-frontend-data:/usr/local/bin/ignition/data
    ports:
      - "${MES_IGNITION_FRONTEND_HTTP_PORT:-8088}:8088"
      - "${MES_IGNITION_FRONTEND_HTTPS_PORT:-8043}:8043"
      - "${MES_IGNITION_FRONTEND_GATEWAY_PORT:-8060}:8060"
    networks:
      - operations-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8088/StatusPing || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # ---------------------------------------------------------------------------
  # Nginx Reverse Proxy - Path Rewriting for Cloudflare Tunnel
  # ---------------------------------------------------------------------------

  mes-nginx:
    <<: *defaults
    image: nginx:${MES_NGINX_VERSION:-alpine}
    container_name: proveit-mes-nginx
    hostname: mes-nginx
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "${MES_NGINX_PORT:-8083}:80"
    networks:
      - operations-network
      - routing-network
    depends_on:
      mes-ignition-backend:
        condition: service_healthy
      mes-ignition-frontend-01:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1/nginx-health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ---------------------------------------------------------------------------
  # Cloudflare Tunnel - External Access
  # ---------------------------------------------------------------------------

  mes-cloudflared:
    <<: *defaults
    image: cloudflare/cloudflared:latest
    container_name: proveit-mes-cloudflared
    hostname: mes-cloudflared
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${MES_CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - routing-network
    depends_on:
      mes-nginx:
        condition: service_healthy
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  proveit-mes-timescaledb-data:
  proveit-mes-ignition-backend-data:
  proveit-mes-ignition-frontend-data:
