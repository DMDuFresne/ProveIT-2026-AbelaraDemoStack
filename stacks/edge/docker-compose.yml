# =============================================================================
# ProveIT 2026 Demo Stack - Edge - Docker Compose Configuration
# =============================================================================
# Description: This file contains the configuration for the Edge services of
# the ProveIT 2026 Demo Stack.
#
# Includes:
#   - Ignition Edge Gateway
#   - Fuuz Device Gateway
#   - Nginx Reverse Proxy
#   - Cloudflare Tunnel
#
# =============================================================================

# =============================================================================
# MINIMAL SHARED CONFIGURATIONS
# =============================================================================
x-defaults: &defaults
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: 100m
      max-file: "5"
  security_opt:
    - no-new-privileges:true

x-common-environment: &common-environment
  TZ: ${EDGE_TZ:-America/Chicago}

x-ignition-common: &ignition-common
  # Common Ignition Gateway Configuration
  # Admin password can be set via GATEWAY_ADMIN_PASSWORD or GATEWAY_ADMIN_PASSWORD_FILE (for secrets)
  GATEWAY_ADMIN_PASSWORD: ${EDGE_IGNITION_GATEWAY_ADMIN_PASSWORD}
  GATEWAY_ADMIN_PASSWORD_FILE: ${EDGE_IGNITION_GATEWAY_ADMIN_PASSWORD_FILE:-}
  IGNITION_EDITION: ${EDGE_IGNITION_EDITION:-edge}
  # Security: Run as non-root user (optional, uncomment and set if needed)
  # IGNITION_UID: ${IGNITION_UID:-}
  # IGNITION_GID: ${IGNITION_GID:-}

# =============================================================================
# NETWORKS - External Networks
# =============================================================================

networks:
  operations-network:
    external: true
  routing-network:
    external: true

# =============================================================================
# SERVICES
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # Ignition Edge Gateway
  # ---------------------------------------------------------------------------

  edge-ignition-gateway-01:
    <<: *defaults
    image: inductiveautomation/ignition:${EDGE_IGNITION_VERSION:-8.3}
    container_name: proveit-edge-ignition-gateway-01
    hostname: edge-ignition-gateway-01
    environment:
      <<: [*common-environment, *ignition-common]
      # EULA Acceptance
      ACCEPT_IGNITION_EULA: Y
      # Admin Credentials
      GATEWAY_ADMIN_USERNAME: ${EDGE_GATEWAY_ADMIN_USERNAME:-admin}
      # Gateway Identification
      GATEWAY_SYSTEM_NAME: ${EDGE_IGNITION_GATEWAY_SYSTEM_NAME:-ProveIT-Edge-Gateway}
      # Network Configuration
      GATEWAY_NETWORK_UUID: ${EDGE_IGNITION_GATEWAY_NETWORK_UUID}
      GATEWAY_NETWORK_ENABLED: ${EDGE_IGNITION_GATEWAY_NETWORK_ENABLED:-true}
      GATEWAY_NETWORK_REQUIRESSL: ${EDGE_IGNITION_GATEWAY_NETWORK_REQUIRESSL:-false}
      GATEWAY_NETWORK_ALLOWINCOMING: ${EDGE_IGNITION_GATEWAY_NETWORK_ALLOWINCOMING:-true}
      # Module Configuration
      GATEWAY_MODULES_ENABLED: ${EDGE_GATEWAY_MODULES_ENABLED:-all}
      # Memory Settings
      GATEWAY_INIT_MEMORY: ${EDGE_GATEWAY_INIT_MEMORY:-512m}
      GATEWAY_MAX_MEMORY: ${EDGE_GATEWAY_MAX_MEMORY:-2048m}
      # Activation/Licensing (can use IGNITION_EDGE_ACTIVATION_TOKEN_FILE for secrets)
      IGNITION_ACTIVATION_TOKEN: ${EDGE_IGNITION_ACTIVATION_TOKEN}
      IGNITION_ACTIVATION_TOKEN_FILE: ${EDGE_IGNITION_ACTIVATION_TOKEN_FILE:-}
      # Feature Flags
      DISABLE_QUICKSTART: ${EDGE_DISABLE_QUICKSTART:-false}
      # Security (optional, uncomment if using non-root user)
      # IGNITION_UID: ${IGNITION_UID:-}
      # IGNITION_GID: ${IGNITION_GID:-}
    volumes:
      - proveit-edge-ignition-gateway-data:/usr/local/bin/ignition/data
    ports:
      - "${EDGE_IGNITION_GATEWAY_HTTP_PORT:-8092}:8088"
      - "${EDGE_IGNITION_GATEWAY_HTTPS_PORT:-8048}:8043"
      - "${EDGE_IGNITION_GATEWAY_GATEWAY_PORT:-8064}:8060"
    networks:
      - operations-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8088/StatusPing || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  # ---------------------------------------------------------------------------
  # Fuuz Device Gateway
  # ---------------------------------------------------------------------------

  edge-fuuz-gateway:
    <<: *defaults
    image: public.ecr.aws/n9a9v7z5/build/mfgx-native-app-device-gateway-server:${EDGE_FUUZ_VERSION:-latest}
    container_name: proveit-edge-fuuz-gateway
    hostname: edge-fuuz-gateway
    pull_policy: always
    stop_grace_period: 60s
    environment:
      <<: *common-environment
      NODE_ENV: ${EDGE_FUUZ_NODE_ENV:-production}
      FUUZ_GATEWAY_AUTO_UPDATE: ${EDGE_FUUZ_GATEWAY_AUTO_UPDATE:-false}
      FUUZ_GATEWAY_LOG_LEVEL: ${EDGE_FUUZ_GATEWAY_LOG_LEVEL:-verbose}
      FUUZ_GATEWAY_LOG_RETENTION_DAYS: ${EDGE_FUUZ_GATEWAY_LOG_RETENTION_DAYS:-30}
      FUUZ_GATEWAY_PORT: ${EDGE_FUUZ_GATEWAY_PORT:-5500}
      FUUZ_GATEWAY_LISTEN_ADDRESS: ${EDGE_FUUZ_GATEWAY_LISTEN_ADDRESS:-0.0.0.0}
    volumes:
      - proveit-edge-fuuz-gateway-app-data:/root/.fuuzdevicegateway
      - proveit-edge-fuuz-gateway-drivers:/fuuzdevicegateway/drivers
    ports:
      - "${EDGE_FUUZ_GATEWAY_PORT_RANGE:-5500-5550}:5500-5550"
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - operations-network
      - routing-network
    command: /fuuzdevicegateway/fuuzdevicegateway
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost ${EDGE_FUUZ_GATEWAY_PORT:-5500} || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ---------------------------------------------------------------------------
  # Nginx Reverse Proxy - Path Rewriting for Cloudflare Tunnel
  # ---------------------------------------------------------------------------

  edge-nginx:
    <<: *defaults
    image: nginx:${EDGE_NGINX_VERSION:-alpine}
    container_name: proveit-edge-nginx
    hostname: edge-nginx
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "${EDGE_NGINX_PORT:-8082}:80"
    networks:
      - operations-network
      - routing-network
    depends_on:
      edge-ignition-gateway-01:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1/nginx-health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ---------------------------------------------------------------------------
  # Cloudflare Tunnel - External Access
  # ---------------------------------------------------------------------------

  edge-cloudflared:
    <<: *defaults
    image: cloudflare/cloudflared:latest
    container_name: proveit-edge-cloudflared
    hostname: edge-cloudflared
    restart: unless-stopped
    command: tunnel --no-autoupdate run --token ${EDGE_CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - routing-network
    depends_on:
      edge-nginx:
        condition: service_healthy
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  proveit-edge-ignition-gateway-data:
  proveit-edge-fuuz-gateway-app-data:
  proveit-edge-fuuz-gateway-drivers:
